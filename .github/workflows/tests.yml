name: Tests

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        service: [authors-service, books-service]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        working-directory: ${{ matrix.service }}
        run: uv pip install --system -e ".[dev]"

      - name: Run tests with coverage
        id: tests
        working-directory: ${{ matrix.service }}
        run: |
          set +e
          output=$(pytest --cov=app --cov-report=term-missing --tb=short 2>&1)
          exit_code=$?
          echo "$output"
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "output<<$EOF" >> "$GITHUB_OUTPUT"
          echo "$output" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          exit $exit_code

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: ${{ matrix.service }}/htmlcov/

      - name: Save report for summary
        if: always()
        run: |
          mkdir -p /tmp/reports
          echo '${{ toJSON(steps.tests.outputs) }}' > /tmp/reports/${{ matrix.service }}.json

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.service }}
          path: /tmp/reports/${{ matrix.service }}.json

  comment:
    needs: tests
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: report-*
          path: reports
          merge-multiple: true

      - name: Build comment body
        id: comment
        run: |
          body="## üß™ Test Results\n\n"
          body+="| Service | Status |\n"
          body+="|---------|--------|\n"

          overall="success"

          for service in authors-service books-service; do
            file="reports/${service}.json"
            if [ -f "$file" ]; then
              exit_code=$(jq -r '.exit_code' "$file")
              if [ "$exit_code" = "0" ]; then
                status="‚úÖ Passed"
              else
                status="‚ùå Failed"
                overall="failure"
              fi
            else
              status="‚ö†Ô∏è No results"
              overall="failure"
            fi
            body+="| \`${service}\` | ${status} |\n"
          done

          if [ "$overall" = "success" ]; then
            body+="\nüü¢ **All tests passed**"
          else
            body+="\nüî¥ **Some tests failed** ‚Äî check the logs for details"
          fi

          body+="\n\n<details>\n<summary>Details per service</summary>\n\n"

          for service in authors-service books-service; do
            file="reports/${service}.json"
            if [ -f "$file" ]; then
              output=$(jq -r '.output // "No output"' "$file")
              body+="### \`${service}\`\n\n\`\`\`\n${output}\n\`\`\`\n\n"
            fi
          done

          body+="</details>"

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> "$GITHUB_OUTPUT"
          echo -e "$body" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: "## üß™ Test Results"

      - name: Post or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find.outputs.comment-id }}
          edit-mode: replace
          body: ${{ steps.comment.outputs.body }}
